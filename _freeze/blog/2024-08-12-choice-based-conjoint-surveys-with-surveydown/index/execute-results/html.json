{
  "hash": "47c175b9a182e37cd1ee07544e6efc1e",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: Choice-based conjoint surveys in R with surveydown\ndescription: |\n  A how-to guide for using R to design and implement choice-based conjoint surveys using the surveydown R package\ndate: '2024-08-08'\npreview: \"images/example.png\"\ncategories:\n  - R\n  - tutorial\n  - conjoint\nformat: html\ntoc: true\nlightbox: true\ndraft: true\n---\n\n\n\n\n<center>\n<img src=\"https://jhelvy.github.io/surveydown/reference/figures/logo.png\" width=200>\n</center>\n\n[surveydown](https://jhelvy.github.io/surveydown/) is a flexible platform for making surveys using `<svg aria-hidden=\"true\" role=\"img\" viewBox=\"0 0 581 512\" style=\"height:1em;width:1.13em;vertical-align:-0.125em;margin-left:auto;margin-right:auto;font-size:inherit;fill:currentColor;overflow:visible;position:relative;\"><path d=\"M581 226.6C581 119.1 450.9 32 290.5 32S0 119.1 0 226.6C0 322.4 103.3 402 239.4 418.1V480h99.1v-61.5c24.3-2.7 47.6-7.4 69.4-13.9L448 480h112l-67.4-113.7c54.5-35.4 88.4-84.9 88.4-139.7zm-466.8 14.5c0-73.5 98.9-133 220.8-133s211.9 40.7 211.9 133c0 50.1-26.5 85-70.3 106.4-2.4-1.6-4.7-2.9-6.4-3.7-10.2-5.2-27.8-10.5-27.8-10.5s86.6-6.4 86.6-92.7-90.6-87.9-90.6-87.9h-199V361c-74.1-21.5-125.2-67.1-125.2-119.9zm225.1 38.3v-55.6c57.8 0 87.8-6.8 87.8 27.3 0 36.5-38.2 28.3-87.8 28.3zm-.9 72.5H365c10.8 0 18.9 11.7 24 19.2-16.1 1.9-33 2.8-50.6 2.9v-22.1z\"/></svg>`{=html} and [quarto](https://quarto.org/). In this post, I'm going to show you one approach for using surveydown to create a choice-based conjoint survey (I'm going to assume that you know what conjoint surveys are, but if not take a look at this [quick introduction](https://sawtoothsoftware.com/conjoint-analysis/cbc)).\n\nThroughout this post, I will use a demo survey about people's preferences for apples with three attributes: `type`, `price`, and `freshness`.^[Yes, people have [actually done conjoint surveys on fruit](https://www.emerald.com/insight/content/doi/10.1108/00070709610150879/full/html) before.] \n\nYou can view the live demo survey [here](), and all files used to create the survey are on [this GitHub repo](https://github.com/pingfan-hu/sdAppleConjoint).\n\n# Introduction\n\nIf you've never used surveydown before, the video on [this page]() offers a 5 minute  conceptual overview. Surveydown brings together three open source technologies\n([Quarto](https://quarto.org/), [shiny](https://shiny.posit.co/), and\n[supabase](https://supabase.com/)) to create dynamic, markdown-based\nsurveys. \n\n<center>\n<img src=\"https://jhelvy.github.io/surveydown/reference/figures/technologies.png\" width=500>\n</center>\n<br>\n\nThe basic concept is:\n\n1.  Design your survey as a [Quarto shiny\n    document](https://quarto.org/docs/dashboards/interactivity/shiny-r.html)\n    using markdown and R code.\n2.  Render your doc into a [shiny](https://shiny.posit.co/) app that can\n    be hosted online and sent to respondents.\n3.  Store your survey responses in a [supabase](https://supabase.com/)\n    database.\n\n# Getting started \n\nAfter getting everything [installed](https://jhelvy.github.io/surveydown/articles/installation.html), it is recommended that you start with a template survey project. You can create one with the following R command:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsurveydown::sd_create_survey(\"path/to/folder\")\n```\n:::\n\n\nThe `\"path/to/folder\"` is the path to wherever you want the template to be created. Once created, you'll see the following files / folders:\n\n```\nexample.qmd\n_extensions\nexample.Rproj\n```\n\nThe only file you will need to edit is the `example.qmd` file. This is the main survey file that you will edit and customize for your survey. The `example.Rproj` is just a project file, which I recommend opening to edit your `example.qmd` file in RStudio (if you're using it). Finally, the `_extensions` folder contains the Quarto extension needed to make everything work. \nIf you have the example open, you can click the \"Run document\" button (in RStudio) or in your terminal run `quarto serve example.qmd`. Either approach should render the example survey into a shiny app that you can preview in a browser. Don't worry just yet about setting up your database or making the survey live just yet - for now, we're going to focus on designing the survey and running it locally to preview it.\n\n# Adding content to your survey \n\nTo edit your survey, you can add plain text with markdown formatting as well as questions defined in R code chunks. Once all of the main survey content (text, images, questions, etc.) are all defined, you can modify the control logic in the server code chunk, found at the bottom of the main survey .qmd file. We'll get to all of this step-by-step.\n\nFor this demo, we have a more detailed example already created that walks you through how to implement a choice-based conjoint survey in a .qmd file with surveydown. You can download this example from [this GitHub repo](https://github.com/pingfan-hu/sdAppleConjoint). I recommend starting with this example when designing your own conjoint survey.\n\n## Adding pages\n\nIn surveydown, pages are delineated using \"fences\", like this:\n\n```\n::: {#welcome .sd-page}\n\nPage 1 content here\n\n:::\n\n::: {#page2 .sd-page}\n\nPage 2 content here\n\n:::\n\n```\n\nAs you can see, we use three colon symbols `:::`, called a \"fence\", to mark the start and end of pages. In the starting fence, you need to define a page name (e.g. `welcome` and `page2` in the example above) and you need to define the class as `.sd-page`. Then anything you put between the page fences will appear on that page. \n\nTo navigate to the next page, you need to insert a `sd_next()` function call, like this: \n\n\n::: {.cell}\n\n```{.r .cell-code}\nsd_next(next_page = 'page2')\n```\n:::\n\n\nIn this case, the above function would need to be placed in a code chunk in between the `:::` fences for the `welcome` page in order to have a \"Next\" button that goes on to page 2. You can also send the user to other pages.\n\n## Adding questions\n\nEvery survey question is created using the `sd_question()` function.\n\n# Defining the choice questions\n\nThe central component of every conjoint survey is the set of randomized choice questions. To implement these in formr, you first need to define the set of choice questions you want to ask each respondent. I use the [cbcTools](https://jhelvy.github.io/cbcTools/) package (which I developed ðŸ˜„) to create these questions. The code to create the choice questions for this demo survey is in the [`make_choice_questions.R`](https://github.com/jhelvy/formr4conjoint/blob/master/survey/make_choice_questions.R) file in the repo.\n\nThe data frame of randomized choice questions is saved as the [`choice_questions.csv`](https://raw.githubusercontent.com/jhelvy/formr4conjoint/master/survey/choice_questions.csv) file. Once created, you'll need to host it somewhere on the web so that you can read it into your Google Sheet. For this demo, the file is hosted on the [GitHub repo](https://github.com/jhelvy/formr4conjoint), but you can also upload your `choice_questions.csv` file inside your Run (see the \"Upload Files\" button on the left side menu), which will generate a unique url to the file.\n\n# Implementing the choice questions\n\nI implement the choice questions in part two of my survey (the  [appleConjoint_p2](https://docs.google.com/spreadsheets/d/1Ih3Pt6uz-gp5vc0SBxBzl4K0aZoRLwI6dtdtZiXSLz0/edit#gid=1611481919) Google Sheet). To do this, I use the first few rows of the sheet to read in the `choice_questions.csv` file and make the following calculations:\n\n1. Randomly generate a `respondentID` by sampling from all possible `respID` values in the choice questions.\n2. Create a new `df` data frame that includes only the rows for the specific `respondentID`.\n3. Create a `df_json` object that converts the `df` data frame to JSON.\n\nThat last step is a bit of a hack, but the reason this is necessary is because each new page on formr is essentially a new `<svg aria-hidden=\"true\" role=\"img\" viewBox=\"0 0 581 512\" style=\"height:1em;width:1.13em;vertical-align:-0.125em;margin-left:auto;margin-right:auto;font-size:inherit;fill:currentColor;overflow:visible;position:relative;\"><path d=\"M581 226.6C581 119.1 450.9 32 290.5 32S0 119.1 0 226.6C0 322.4 103.3 402 239.4 418.1V480h99.1v-61.5c24.3-2.7 47.6-7.4 69.4-13.9L448 480h112l-67.4-113.7c54.5-35.4 88.4-84.9 88.4-139.7zm-466.8 14.5c0-73.5 98.9-133 220.8-133s211.9 40.7 211.9 133c0 50.1-26.5 85-70.3 106.4-2.4-1.6-4.7-2.9-6.4-3.7-10.2-5.2-27.8-10.5-27.8-10.5s86.6-6.4 86.6-92.7-90.6-87.9-90.6-87.9h-199V361c-74.1-21.5-125.2-67.1-125.2-119.9zm225.1 38.3v-55.6c57.8 0 87.8-6.8 87.8 27.3 0 36.5-38.2 28.3-87.8 28.3zm-.9 72.5H365c10.8 0 18.9 11.7 24 19.2-16.1 1.9-33 2.8-50.6 2.9v-22.1z\"/></svg>`{=html} session, so every time you start a new page all your previous objects are no longer there and all your libraries need to be re-loaded. The only objects you have access to on separate pages are items that are stored in the resulting survey data (using the names assigned in the `name` column), so we have to serialize the `df` object into one long JSON object so that we can access it later in other pages.\n\nOnce we have everything set up, we can then start defining choice questions. In each choice question row, the first thing I do is define the questions label and then write a code chunk to create multiple data frames to store the values to display for each alternative. For example, on row 10 of the [appleConjoint_p2](https://docs.google.com/spreadsheets/d/1Ih3Pt6uz-gp5vc0SBxBzl4K0aZoRLwI6dtdtZiXSLz0/edit#gid=1611481919) Google Sheet, you can see the following code chunk under the question label:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(dplyr)\nalts <- jsonlite::unserializeJSON(df_json) %>% \n  filter(qID == 1)\nalt1 <- alts %>% filter(altID == 1)\nalt2 <- alts %>% filter(altID == 2)\nalt3 <- alts %>% filter(altID == 3)\n```\n:::\n\n\nIn this chunk, the `alts` data frame is created by converting the `df_json` object into a data frame and filtering for all alternatives for the first question. Then the `alts` data frame is broken into three more data frames (`alt1`, `alt2`, and `alt3`) which contain the information about each alternative. These data frames are then used to display information about each alternative. For example, the first alternative is defined using this code:\n\n\n::: {.cell}\n\n```{.r .cell-code}\n**Option 1**\n\n<img src=`r alt1$image` width=100>\n\n**Type**: `r alt1$type`\n**Price**: $ `r alt1$price` / lb\n**Freshness**: `r alt1$freshness`\n```\n:::\n\n\nI copy this code over to each alternative, adjusting the numbers for alternative 2 and 3. When rendered in formr, the three options looks like this:\n\n<center>\n<img src=\"images/example.png\" width=500>\n</center>\n\nAnd that's it! The nice thing about this approach is that the only thing I need to modify in these code chunks for the remaining choice questions is the question number used to define the `alts` data frame. Other than that, the code for the question label and the alternatives can be reused on the rest of the choice questions.\n\n# Buttons versus tables \n\nIn the example above, the conjoint choice questions are displayed as \"buttons\" where all the information for each alternative is shown as a button. This works particularly well for mobile phone applications where the user may need to scroll vertically to see each option. \n\nAn alternative is to use a tabular layout where each column represents an alternative and the row names explain the attribute. This takes a little manipulation to get it right, but the key concept is to use `kable()` to display the transpose of the `alts` data frame. I also use the wonderful [kableExtra](https://cran.r-project.org/web/packages/kableExtra/vignettes/awesome_table_in_html.html) package to modify some of the table stying. If you want to see this version in practice, the survey link is [here](https://appleconjointtable.formr.org/), and the Google Sheet with the configurtions for this is [here](https://docs.google.com/spreadsheets/d/1EG14Eh9kDBvE_iETfm6l6g90mrQ5sl_zbWaXkwIOGLU). \n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(dplyr)\nlibrary(kableExtra)\nalts <- jsonlite::unserializeJSON(df_json) %>%\n  filter(qID == 1) %>% \n  mutate(\n    price = paste(scales::dollar(price), \"/ lb\"),\n    image = paste0('<img src=\"', image, '\" width=100>')) %>% \n  # Make nicer attribute labels\n  select(\n    `Option:` = altID, \n    ` ` = image,\n    `Price:` = price, \n    `Type:` = type, \n    `Freshness:` = freshness)\nrow.names(alts) <- NULL # Drop row names\n\nkable(t(alts), escape = FALSE) %>% \n  kable_styling(\n    bootstrap_options = c(\"striped\", \"hover\", \"condensed\"), \n    full_width = FALSE, \n    position = \"center\"\n  )\n```\n:::\n\n\n<center>\n<img src=\"images/cbc_table.png\" width=500>\n</center>\n\n# Implementing the surveys in formr\n\nYou'll need to upload each Google Sheet survey into formr to convert them into surveys. Go to your admin page, click on \"Create Survey\", then import one of the Google Sheets. This creates one survey. On the left panel you can click \"Test Survey\" to preview it.\n\nOnce you have all three surveys loaded into formr, you can then assemble them into a \"Run\" by clicking on \"Runs -> Create New Run\". Give the run a name, then add your survey to the run by clicking on the `<svg aria-hidden=\"true\" role=\"img\" viewBox=\"0 0 512 512\" style=\"height:1em;width:1em;vertical-align:-0.125em;margin-left:auto;margin-right:auto;font-size:inherit;fill:currentColor;overflow:visible;position:relative;\"><path d=\"M441 58.9L453.1 71c9.4 9.4 9.4 24.6 0 33.9L424 134.1 377.9 88 407 58.9c9.4-9.4 24.6-9.4 33.9 0zM209.8 256.2L344 121.9 390.1 168 255.8 302.2c-2.9 2.9-6.5 5-10.4 6.1l-58.5 16.7 16.7-58.5c1.1-3.9 3.2-7.5 6.1-10.4zM373.1 25L175.8 222.2c-8.7 8.7-15 19.4-18.3 31.1l-28.6 100c-2.4 8.4-.1 17.4 6.1 23.6s15.2 8.5 23.6 6.1l100-28.6c11.8-3.4 22.5-9.7 31.1-18.3L487 138.9c28.1-28.1 28.1-73.7 0-101.8L474.9 25C446.8-3.1 401.2-3.1 373.1 25zM88 64C39.4 64 0 103.4 0 152V424c0 48.6 39.4 88 88 88H360c48.6 0 88-39.4 88-88V312c0-13.3-10.7-24-24-24s-24 10.7-24 24V424c0 22.1-17.9 40-40 40H88c-22.1 0-40-17.9-40-40V152c0-22.1 17.9-40 40-40H200c13.3 0 24-10.7 24-24s-10.7-24-24-24H88z\"/></svg>`{=html} icon. You'll want to add all three surveys, and then at the end add a stopping point by clicking the `<svg aria-hidden=\"true\" role=\"img\" viewBox=\"0 0 384 512\" style=\"height:1em;width:0.75em;vertical-align:-0.125em;margin-left:auto;margin-right:auto;font-size:inherit;fill:currentColor;overflow:visible;position:relative;\"><path d=\"M0 128C0 92.7 28.7 64 64 64H320c35.3 0 64 28.7 64 64V384c0 35.3-28.7 64-64 64H64c-35.3 0-64-28.7-64-64V128z\"/></svg>`{=html} icon. You can use other logic to control how the user navigates through the survey, such as a \"Skip Forward\" (`<svg aria-hidden=\"true\" role=\"img\" viewBox=\"0 0 512 512\" style=\"height:1em;width:1em;vertical-align:-0.125em;margin-left:auto;margin-right:auto;font-size:inherit;fill:currentColor;overflow:visible;position:relative;\"><path d=\"M52.5 440.6c-9.5 7.9-22.8 9.7-34.1 4.4S0 428.4 0 416V96C0 83.6 7.2 72.3 18.4 67s24.5-3.6 34.1 4.4L224 214.3V256v41.7L52.5 440.6zM256 352V256 128 96c0-12.4 7.2-23.7 18.4-29s24.5-3.6 34.1 4.4l192 160c7.3 6.1 11.5 15.1 11.5 24.6s-4.2 18.5-11.5 24.6l-192 160c-9.5 7.9-22.8 9.7-34.1 4.4s-18.4-16.6-18.4-29V352z\"/></svg>`{=html} icon) to screen respondents out before letting them get to a later part of the survey. \n\nThe specific logic used in this demo is as follows:\n\n```\nStart (part 1)\n  |\n  V\nCheck screen out question --> Screen out non-target respondents\n  |\n  V\nChoice questions (part 2)\n  |\n  V\nCheck choice responses --> Screen out respondents that chose \n  |                        all same responses\n  V\nFinal demographic and other questions (part 3)\n  |\n  V\nFinish\n```\n\nNotice that there are two points where respondents can be screened out of the survey:\n\n1. At the end of part 1, I ask a question to identify if the respondent is part of the target population I am interested in. This allows me to screen people out of the survey eary on before they get too far in if they're not who I'm looking for. In this demo, I ask if they prefer the color Red or Blue and screen out people who chose Blue.\n2. At the end of part 2, I compute whether or not the respondent chose the same response for every choice question or not, which is a good indicator that they were probably just clicking through the survey. I don't want these respondents in my sample, so I screen them out here.\n\nHere is a screenshot of the specific run settings:\n\n<center>\n<img src=\"images/run.png\" width=100%>\n</center>\n\n# Time stamps `<svg aria-hidden=\"true\" role=\"img\" viewBox=\"0 0 512 512\" style=\"height:1em;width:1em;vertical-align:-0.125em;margin-left:auto;margin-right:auto;font-size:inherit;fill:currentColor;overflow:visible;position:relative;\"><path d=\"M464 256A208 208 0 1 1 48 256a208 208 0 1 1 416 0zM0 256a256 256 0 1 0 512 0A256 256 0 1 0 0 256zM232 120V256c0 8 4 15.5 10.7 20l96 64c11 7.4 25.9 4.4 33.3-6.7s4.4-25.9-6.7-33.3L280 243.2V120c0-13.3-10.7-24-24-24s-24 10.7-24 24z\"/></svg>`{=html}\n\nSince your entire survey is designed in `<svg aria-hidden=\"true\" role=\"img\" viewBox=\"0 0 581 512\" style=\"height:1em;width:1.13em;vertical-align:-0.125em;margin-left:auto;margin-right:auto;font-size:inherit;fill:currentColor;overflow:visible;position:relative;\"><path d=\"M581 226.6C581 119.1 450.9 32 290.5 32S0 119.1 0 226.6C0 322.4 103.3 402 239.4 418.1V480h99.1v-61.5c24.3-2.7 47.6-7.4 69.4-13.9L448 480h112l-67.4-113.7c54.5-35.4 88.4-84.9 88.4-139.7zm-466.8 14.5c0-73.5 98.9-133 220.8-133s211.9 40.7 211.9 133c0 50.1-26.5 85-70.3 106.4-2.4-1.6-4.7-2.9-6.4-3.7-10.2-5.2-27.8-10.5-27.8-10.5s86.6-6.4 86.6-92.7-90.6-87.9-90.6-87.9h-199V361c-74.1-21.5-125.2-67.1-125.2-119.9zm225.1 38.3v-55.6c57.8 0 87.8-6.8 87.8 27.3 0 36.5-38.2 28.3-87.8 28.3zm-.9 72.5H365c10.8 0 18.9 11.7 24 19.2-16.1 1.9-33 2.8-50.6 2.9v-22.1z\"/></svg>`{=html}, why not take advantage of that fact to collect more about your respondents? One thing I always do on my formr surveys is grab the time each respondent spends on every page. This is implemented by running `Sys.time()` at the top of every new page, which I then use to compute the _difference_ between each time stamp to get the time spent on every page. This is useful in general just to be more informed about how your respondents are going through your survey, and particularly useful for examining behavior on the conjoint choice questions.\n\n# Preview and check\n\nThe link to the survey will be `https://your_run_name.formr.org`. You can control whether your survey is \"live\" or not by modifying the \"volume\" icons. For collecting data, I recommend setting it to the `<svg aria-hidden=\"true\" role=\"img\" viewBox=\"0 0 448 512\" style=\"height:1em;width:0.88em;vertical-align:-0.125em;margin-left:auto;margin-right:auto;font-size:inherit;fill:currentColor;overflow:visible;position:relative;\"><path d=\"M301.1 34.8C312.6 40 320 51.4 320 64V448c0 12.6-7.4 24-18.9 29.2s-25 3.1-34.4-5.3L131.8 352H64c-35.3 0-64-28.7-64-64V224c0-35.3 28.7-64 64-64h67.8L266.7 40.1c9.4-8.4 22.9-10.4 34.4-5.3zM412.6 181.5C434.1 199.1 448 225.9 448 256s-13.9 56.9-35.4 74.5c-10.3 8.4-25.4 6.8-33.8-3.5s-6.8-25.4 3.5-33.8C393.1 284.4 400 271 400 256s-6.9-28.4-17.7-37.3c-10.3-8.4-11.8-23.5-3.5-33.8s23.5-11.8 33.8-3.5z\"/></svg>`{=html} icon, which means people who have the link can access the survey.\n\nBut before you go live, it's a good idea to do some quick testing. You can test each survey separately from their respective survey admin pages, and you can also test the entire run from the run admin page (check the left side menu). When testing, you may get an error - don't panic! The error pages look a little different from the errors you're used to in R, but if you click through the errors you can usually find the root cause of the error (the R error message will be buried somewhere on the page). Many times the errors are small typos, which is another reason why I like to initially build my surveys in .Rmd files - when I knit them to html pages, any typos or other small errors are much more easily identified.\n\n# Getting the data\n\nOnce your survey is live and you start collecting responses, your response data will not be available in the \"Run\". Instead, they will be available in each of the three survey pages. You can use the [{formr} package](https://github.com/rubenarslan/formr) to import the data directly in `<svg aria-hidden=\"true\" role=\"img\" viewBox=\"0 0 581 512\" style=\"height:1em;width:1.13em;vertical-align:-0.125em;margin-left:auto;margin-right:auto;font-size:inherit;fill:currentColor;overflow:visible;position:relative;\"><path d=\"M581 226.6C581 119.1 450.9 32 290.5 32S0 119.1 0 226.6C0 322.4 103.3 402 239.4 418.1V480h99.1v-61.5c24.3-2.7 47.6-7.4 69.4-13.9L448 480h112l-67.4-113.7c54.5-35.4 88.4-84.9 88.4-139.7zm-466.8 14.5c0-73.5 98.9-133 220.8-133s211.9 40.7 211.9 133c0 50.1-26.5 85-70.3 106.4-2.4-1.6-4.7-2.9-6.4-3.7-10.2-5.2-27.8-10.5-27.8-10.5s86.6-6.4 86.6-92.7-90.6-87.9-90.6-87.9h-199V361c-74.1-21.5-125.2-67.1-125.2-119.9zm225.1 38.3v-55.6c57.8 0 87.8-6.8 87.8 27.3 0 36.5-38.2 28.3-87.8 28.3zm-.9 72.5H365c10.8 0 18.9 11.7 24 19.2-16.1 1.9-33 2.8-50.6 2.9v-22.1z\"/></svg>`{=html}, or just go to the admin page for each survey and download the data as .csv files. The key piece to remember is that each respondent will be given a unique `session` variable that you can use to join all of the three separate data files together.\n\nWith that in mind, keep an eye out for a follow on post on how to join and clean the resulting data from this conjoint demo coming soon!",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}